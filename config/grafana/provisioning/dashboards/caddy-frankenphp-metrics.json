{
    "uid": "caddy-and-frankenphp-infrastructure",
    "title": "Caddy & FrankenPHP Infrastructure",
    "timezone": "browser",
    "schemaVersion": 38,
    "time": {
        "from": "now-15m",
        "to": "now"
    },
    "refresh": "10s",
    "tags": ["stocks-api", "http", "requests", "infrastructure", "php", "caddy", "frankenphp"],
    "panels": [
        {
            "type": "stat",
            "title": "Total RPS",
            "gridPos": { "x": 0, "y": 0, "w": 6, "h": 6 },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart)\n  |> filter(fn: (r) => r._measurement == \"caddy_caddy_http_requests_total\")\n  |> filter(fn: (r) => r.handler == \"php\")\n  |> derivative(unit: 1s, nonNegative: true)\n  |> sum()\n  |> last()",
                    "refId": "A"
                }
            ],
            "fieldConfig": { "defaults": { "unit": "reqps", "decimals": 1 } }
        },
        {
            "type": "stat",
            "title": "Busy PHP Threads",
            "gridPos": { "x": 6, "y": 0, "w": 6, "h": 6 },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart)\n  |> filter(fn: (r) => r._measurement == \"caddy_frankenphp_busy_threads\")\n  |> last()",
                    "refId": "A"
                }
            ],
            "fieldConfig": {
                "defaults": { "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 10 }] } }
            }
        },
        {
            "type": "stat",
            "title": "P95 Latency (PHP)",
            "gridPos": { "x": 12, "y": 0, "w": 6, "h": 6 },
            "targets": [
                {
                    "refId": "A",
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"caddy_caddy_http_request_duration_seconds\")\n  |> filter(fn: (r) => r.handler == \"php\")\n  |> group(columns: [\"handler\", \"server\", \"url\", \"_field\"])\n |> aggregateWindow(every: 1s, fn: last, createEmpty: false)\n |> derivative(unit: 1s, nonNegative: true)\n  |> group()\n  |> aggregateWindow(every: v.windowPeriod, fn: (column, tables=<-) => tables |> quantile(q: 0.95))\n  |> map(fn: (r) => ({ _time: r._time, _value: r._value * 1000.0 }))\n  |> last()"
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "unit": "ms",
                    "decimals": 2,
                    "color": { "mode": "thresholds" },
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            { "color": "green", "value": null },
                            { "color": "yellow", "value": 200 },
                            { "color": "red", "value": 500 }
                        ]
                    }
                }
            },
            "options": {
                "graphMode": "area",
                "colorMode": "value",
                "justifyMode": "auto"
            }
        },
        {
            "type": "stat",
            "title": "RAM Usage",
            "gridPos": { "x": 18, "y": 0, "w": 6, "h": 6 },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart)\n  |> filter(fn: (r) => r._measurement == \"caddy_process_resident_memory_bytes\")\n  |> map(fn: (r) => ({ _time: r._time, _value: float(v: r._value) / 1024.0 / 1024.0 }))\n  |> last()",
                    "refId": "A"
                }
            ],
            "fieldConfig": { "defaults": { "unit": "decbytes" } }
        },
        {
            "type": "timeseries",
            "title": "Active PHP Requests (In-flight)",
            "gridPos": { "x": 0, "y": 6, "w": 24, "h": 8 },
            "targets": [
                {
                    "refId": "A",
                    "query": "from(bucket: \"stockbucket\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"caddy_caddy_http_requests_in_flight\")\n  |> filter(fn: (r) => r.handler == \"php\")\n  |> aggregateWindow(every: v.windowPeriod, fn: max, createEmpty: false)"
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "unit": "none",
                    "custom": {
                        "drawStyle": "line",
                        "lineInterpolation": "stepAfter",
                        "fillOpacity": 10,
                        "pointSize": 5,
                        "showPoints": "auto"
                    },
                    "color": { "mode": "fixed", "fixedColor": "yellow" },
                    "displayName": "In-flight Requests"
                }
            },
            "options": {
                "legend": { "displayMode": "list", "placement": "bottom", "calcs": ["max", "last"] }
            }
        },
        {
            "type": "timeseries",
            "title": "HTTP Traffic (RPS by Handler/URL)",
            "gridPos": { "x": 0, "y": 14, "w": 24, "h": 8 },
            "targets": [
                {
                    "refId": "A",
                    "query": "from(bucket: \"stockbucket\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"caddy_caddy_http_requests_total\")\n  |> filter(fn: (r) => r._field == \"counter\")\n  |> group(columns: [\"handler\", \"url\"])\n  |> derivative(unit: 1s, nonNegative: true)\n  |> aggregateWindow(every: v.windowPeriod, fn: sum)"                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": { "drawStyle": "line", "fillOpacity": 20, "stacking": { "mode": "normal" } },
                    "unit": "reqps"
                }
            }
        },
        {
            "type": "timeseries",
            "title": "Memory & CPU Load",
            "gridPos": { "x": 0, "y": 22, "w": 24, "h": 8 },
            "targets": [
                {
                    "refId": "CPU",
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"caddy_process_cpu_seconds_total\")\n  |> derivative(unit: 1s, nonNegative: true)\n  |> map(fn: (r) => ({ _time: r._time, _value: r._value * 100.0, _field: \"CPU %\" }))",
                    "displayName": "CPU Usage (%)"
                },
                {
                    "refId": "Mem",
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"caddy_process_resident_memory_bytes\")\n  |> map(fn: (r) => ({ _time: r._time, _value: float(v: r._value) / 1024.0 / 1024.0, _field: \"RAM MB\" }))",
                    "displayName": "Memory (MB)"
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": { "axisPlacement": "auto", "axisLabel": "" }
                },
                "overrides": [
                    {
                        "matcher": { "id": "byName", "options": "CPU Usage (%)" },
                        "properties": [
                            { "id": "unit", "value": "percent" },
                            { "id": "custom.axisPlacement", "value": "left" }
                        ]
                    },
                    {
                        "matcher": { "id": "byName", "options": "Memory (MB)" },
                        "properties": [
                            { "id": "unit", "value": "decbytes" },
                            { "id": "custom.axisPlacement", "value": "right" }
                        ]
                    }
                ]
            }
        }
    ]
}
