{
    "title": "System/Dev Ops",
    "uid": "system-ops-server",
    "version": 1,
    "schemaVersion": 39,
    "refresh": "10s",
    "time": {
        "from": "now-15m",
        "to": "now"
    },
    "timezone": "browser",
    "tags": [
        "stocks-api",
        "system",
        "telegraf",
        "influxdb",
        "docker"
    ],
    "panels": [
        {
            "type": "timeseries",
            "title": "Host CPU (usage_active, total)",
            "gridPos": {
                "x": 0,
                "y": 0,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"cpu\" and r.cpu == \"cpu-total\" and r._field == \"usage_active\")\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    },
                    "hide": false
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": {},
                    "unit": "percentunit"
                },
                "overrides": []
            },
            "options": {
                "legend": {
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                },
                "tooltip": {
                    "mode": "multi",
                    "sort": "none"
                }
            }
        },
        {
            "type": "timeseries",
            "title": "Memory used %",
            "gridPos": {
                "x": 12,
                "y": 0,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"mem\" and r._field == \"used_percent\")\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    },
                    "hide": false
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": {},
                    "unit": "percentunit"
                },
                "overrides": []
            },
            "options": {
                "legend": {
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                },
                "tooltip": {
                    "mode": "multi",
                    "sort": "none"
                }
            }
        },
        {
            "type": "timeseries",
            "title": "Disk used % (per path)",
            "gridPos": {
                "x": 0,
                "y": 8,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"disk\" and r._field == \"used_percent\")\n  |> group(columns: [\"path\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    },
                    "hide": false
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": {},
                    "unit": "percentunit"
                },
                "overrides": []
            },
            "options": {
                "legend": {
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                },
                "tooltip": {
                    "mode": "multi",
                    "sort": "none"
                }
            }
        },
        {
            "type": "timeseries",
            "title": "Network RX/TX (bytes/sec)",
            "gridPos": {
                "x": 12,
                "y": 8,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"net\" and (r._field == \"bytes_recv\" or r._field == \"bytes_sent\"))\n  |> derivative(unit: 1s, nonNegative: true)\n  |> group(columns: [\"interface\", \"_field\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    },
                    "hide": false
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": {},
                    "unit": "Bps"
                },
                "overrides": []
            },
            "options": {
                "legend": {
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                },
                "tooltip": {
                    "mode": "multi",
                    "sort": "none"
                }
            }
        },
        {
            "type": "timeseries",
            "title": "Docker CPU % by container",
            "gridPos": {
                "x": 0,
                "y": 16,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"docker_container_cpu\" and r._field == \"usage_percent\")\n  |> group(columns: [\"container_name\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    },
                    "hide": false
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": {},
                    "unit": "percent"
                },
                "overrides": []
            },
            "options": {
                "legend": {
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                },
                "tooltip": {
                    "mode": "multi",
                    "sort": "none"
                }
            }
        },
        {
            "type": "timeseries",
            "title": "Docker Memory (MiB) by container",
            "gridPos": {
                "x": 12,
                "y": 16,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"docker_container_mem\" and r._field == \"usage\")\n  |> keep(columns: [\"_time\",\"_value\",\"container_name\"])\n  |> toFloat()\n  |> group(columns: [\"container_name\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n  |> map(fn: (r) => ({ r with _value: r._value / 1048576.0 }))",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": { "type": "influxdb", "uid": "DS_INFLUXDB" },
                    "hide": false
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": {},
                    "unit": "decmbytes"
                },
                "overrides": []
            },
            "options": {
                "legend": {
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                },
                "tooltip": {
                    "mode": "multi",
                    "sort": "none"
                }
            }
        },
        {
            "type": "timeseries",
            "title": "System Load Average (1/5/15)",
            "gridPos": {
                "x": 0,
                "y": 24,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "query": "import \"influxdata/influxdb/schema\"\nfrom(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"system\" and (r._field == \"load1\" or r._field == \"load5\" or r._field == \"load15\"))\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    },
                    "hide": false
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "custom": {}
                },
                "overrides": []
            },
            "options": {
                "legend": {
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                },
                "tooltip": {
                    "mode": "multi",
                    "sort": "none"
                }
            }
        },
        {
            "type": "stat",
            "title": "Uptime (hours)",
            "gridPos": {
                "x": 12,
                "y": 24,
                "w": 4,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"system\" and r._field == \"uptime\")\n  |> last()\n  |> map(fn: (r) => ({ r with _value: float(v: r._value) / 3600.0 }))",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    }
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "mappings": [],
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": null
                            }
                        ]
                    },
                    "unit": "h"
                },
                "overrides": []
            },
            "options": {
                "reduceOptions": {
                    "calcs": [
                        "lastNotNull"
                    ],
                    "fields": "",
                    "values": false
                },
                "orientation": "auto",
                "colorMode": "value",
                "graphMode": "none",
                "justifyMode": "auto"
            }
        },
        {
            "type": "timeseries",
            "title": "Total Memory (GiB) over time",
            "gridPos": { "x": 20, "y": 24, "w": 4, "h": 8 },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"docker\" and r._field == \"memory_total\")\n  |> toFloat()\n  |> map(fn: (r) => ({ r with _value: r._value / 1073741824.0 }))\n  |> aggregateWindow(every: v.windowPeriod, fn: last, createEmpty: false)\n |> yield(name: \"mean\")",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": { "type": "influxdb", "uid": "DS_INFLUXDB" }
                }
            ],
            "fieldConfig": { "defaults": { "unit": "decgbytes" }, "overrides": [] },
            "options": {
                "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
                "tooltip": { "mode": "multi", "sort": "none" }
            }
        },
        {
            "type": "stat",
            "title": "Total CPU process",
            "gridPos": { "x": 16, "y": 24, "w": 4, "h": 8 },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"docker\" and r._field == \"n_cpus\")\n  |> toFloat()\n |> aggregateWindow(every: v.windowPeriod, fn: last, createEmpty: false)\n |> last()",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": { "type": "influxdb", "uid": "DS_INFLUXDB" }
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "mappings": [],
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": null
                            }
                        ]
                    },
                    "unit": "none"
                },
                "overrides": []
            },
            "options": {
                "reduceOptions": {
                    "calcs": [
                        "lastNotNull"
                    ],
                    "fields": "",
                    "values": false
                },
                "orientation": "auto",
                "colorMode": "value",
                "graphMode": "none",
                "justifyMode": "auto"
            }
        },
        {
            "type": "table",
            "title": "Top 5 Containers by CPU (last 5m)",
            "gridPos": {
                "x": 0,
                "y": 32,
                "w": 24,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: -5m, stop: now())\n  |> filter(fn: (r) => r._measurement == \"docker_container_cpu\" and r._field == \"usage_percent\")\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\n  |> group(columns: [\"container_name\"])\n  |> last()\n  |> sort(columns: [\"_value\"], desc: true)\n  |> limit(n: 5)",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    }
                }
            ],
            "fieldConfig": {
                "defaults": {},
                "overrides": []
            },
            "options": {
                "showHeader": true
            }
        },
        {
            "type": "table",
            "title": "Top 5 Containers by Memory (MiB, last 5m)",
            "gridPos": {
                "x": 0,
                "y": 40,
                "w": 24,
                "h": 8
            },
            "targets": [
                {
                    "query": "from(bucket: v.defaultBucket)\n  |> range(start: -5m, stop: now())\n  |> filter(fn: (r) => r._measurement == \"docker_container_mem\" and r._field == \"usage\")\n  |> keep(columns: [\"_time\",\"_value\",\"container_name\"])\n  |> toFloat()\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\n  |> group(columns: [\"container_name\"])\n  |> last()\n  |> map(fn: (r) => ({ r with _value: r._value / 1048576.0 }))\n  |> sort(columns: [\"_value\"], desc: true)\n  |> limit(n: 5)",
                    "refId": "A",
                    "queryType": "flux",
                    "datasource": {
                        "type": "influxdb",
                        "uid": "DS_INFLUXDB"
                    }
                }
            ],
            "fieldConfig": {
                "defaults": {},
                "overrides": []
            },
            "options": {
                "showHeader": true
            }
        }
    ]
}
